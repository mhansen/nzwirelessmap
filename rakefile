file "prism.zip" do |t|
  sh "wget https://www.rsm.govt.nz/assets/Uploads/documents/prism/prism.zip"
end

file "prism.mdb" => ["prism.zip"] do |t|
  sh "unzip prism.zip"
end

file "prism.sqlite3" => ["prism.mdb"] do |t|
  sh "rm -f #{t.name}"
  sh "java -jar lib/mdb-sqlite.jar #{t.prerequisites[0]} #{t.name}"
  # by default, the generated database has no idea what it looks like, so it
  # makes all kinds of bad decisions when planning queries. We ask the database
  # to analyze itself, so it can make an informed decision about how to do
  # massive JOINs.
  sh "echo 'analyze main;' | sqlite3 #{t.name}"
end

file "point_to_point_links.csv" => ["prism.sqlite3", "select_point_to_point_links.sql"] do |t|
  sh "cat select_point_to_point_links.sql | sqlite3 prism.sqlite3 > #{t.name}"
end

file "point_to_point_links.json" => ["point_to_point_links.csv", "csv2json.py"] do |t|
  sh "cat point_to_point_links.csv | python3 csv2json.py > #{t.name}"
end

task "deploy_to_app_engine" => ["site/static/index.js"] do
  sh "~/Downloads/google_appengine/appcfg.py update site2/ --oauth2"
end
